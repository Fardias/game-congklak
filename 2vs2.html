<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Congklak Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type=range].range-yellow {
            accent-color: #a16207;
        }

        input[type=range].range-yellow::-webkit-slider-runnable-track {
            background: #fde68a;
            height: 6px;
            border-radius: 9999px;
        }

        input[type=range].range-yellow::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            background: #a16207;
            border-radius: 9999px;
            margin-top: -5px;
        }

        input[type=range].range-yellow::-moz-range-track {
            background: #fde68a;
            height: 6px;
            border-radius: 9999px;
        }

        input[type=range].range-yellow::-moz-range-thumb {
            background: #a16207;
            height: 16px;
            width: 16px;
            border: none;
            border-radius: 9999px;
        }
    </style>
</head>

<body class=" flex flex-col items-center justify-center min-h-screen">

    <div class="absolute top-4 right-4" id="settingsBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-gear-fill"
            viewBox="0 0 16 16">
            <path
                d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" />
        </svg>
    </div>
    <div id="settingsPanel" class="absolute top-16 right-4 hidden w-64 bg-white rounded-lg shadow-lg p-4 z-40">
        <div class="space-y-3">
            <label class="block">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-700">Volume</span>
                    <span id="volumeValue" class="text-sm text-gray-700">70%</span>
                </div>
                <input type="range" id="volumeSlider" min="0" max="100" step="1" class="mt-2 w-full range-yellow">
            </label>
            <a href="index.html"
                class="block text-center px-3 py-2 rounded-md bg-yellow-700 text-white hover:opacity-80">Kembali ke
                Home</a>
        </div>
    </div>
    <div id="winnerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md p-6 text-center">
            <h2 class="text-xl font-bold text-yellow-700 mb-2">Hasil Permainan</h2>
            <p id="winnerText" class="text-gray-800 mb-2">Pemenang: -</p>
            <div id="scoreText" class="text-sm text-gray-600 mb-6">Player 1: 0 • Player 2: 0</div>
            <div class="flex justify-center space-x-3">
                <button id="playAgainBtn" class="px-4 py-2 rounded-md bg-yellow-700 text-white hover:opacity-80">Main
                    Lagi</button>
                <a href="index.html" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">Kembali ke
                    Home</a>
            </div>
        </div>
    </div>


    <canvas id="congklakCanvas" width="700" height="300" class=""></canvas>
    <audio id="bgAudio" src="song.mp3" preload="auto" loop></audio>

    <script>
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const audio = document.getElementById('bgAudio');
        const winnerModal = document.getElementById('winnerModal');
        const winnerText = document.getElementById('winnerText');
        const scoreText = document.getElementById('scoreText');
        const playAgainBtn = document.getElementById('playAgainBtn');
        let audioPlayed = false;

        function initAudioFromStorage() {
            const saved = parseFloat(localStorage.getItem('volume') || '0.7');
            const vol = isNaN(saved) ? 0.7 : Math.max(0, Math.min(1, saved));
            audio.volume = vol;
            audio.loop = true;
            if (volumeSlider) volumeSlider.value = String(Math.round(vol * 100));
            if (volumeValue) volumeValue.textContent = volumeSlider.value + '%';
        }

        function tryPlayAudio() {
            // console.log("mencoba memainkan audio");

            audio.play().then(() => { audioPlayed = true; }).catch(() => { });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initAudioFromStorage();
            tryPlayAudio();
        });

        function ensureAudioOnFirstInteraction() {
            if (audioPlayed) return;
            const handler = () => {
                initAudioFromStorage();
                tryPlayAudio();
                document.removeEventListener('click', handler);
                document.removeEventListener('keydown', handler);
            };
            document.addEventListener('click', handler, { once: true });
            document.addEventListener('keydown', handler, { once: true });
        }
        ensureAudioOnFirstInteraction();

        settingsBtn.addEventListener('click', () => {
            const isHidden = settingsPanel.classList.contains('hidden');
            if (isHidden) settingsPanel.classList.remove('hidden'); else settingsPanel.classList.add('hidden');
        });

        volumeSlider.addEventListener('input', function () {
            const vol = parseInt(volumeSlider.value, 10);
            const norm = Math.max(0, Math.min(100, isNaN(vol) ? 70 : vol)) / 100;
            audio.volume = norm;
            if (volumeValue) volumeValue.textContent = String(Math.round(norm * 100)) + '%';
        });

        volumeSlider.addEventListener('change', function () {
            const vol = parseInt(volumeSlider.value, 10);
            const norm = Math.max(0, Math.min(100, isNaN(vol) ? 70 : vol)) / 100;
            localStorage.setItem('volume', String(norm));
        });

        const canvas = document.getElementById("congklakCanvas");
        const ctx = canvas.getContext("2d");
        const woodImg = new Image();
        woodImg.src = 'img/tekstur-kayu.png';
        let boardPattern = null;
        woodImg.onload = () => {
            boardPattern = ctx.createPattern(woodImg, 'repeat');
            render();
        };

        const lubang = [];

        // 7 lubang Player 1 (atas)
        for (let i = 0; i < 7; i++) {
            lubang.push({ x: 125 + i * 75, y: 100, r: 25, biji: 1 });
        }

        // 7 lubang Player 2 (bawah)
        for (let i = 0; i < 7; i++) {
            lubang.push({ x: 125 + (6 - i) * 75, y: 200, r: 25, biji: 1 });
        }

        // lubah besar kiri (Player 2)
        lubang.push({ x: 50, y: 150, r: 35, biji: 0, big: true });

        // lubah besar kanan (Player 1)
        lubang.push({ x: 650, y: 150, r: 35, biji: 0, big: true });

        function drawlubang() {
            lubang.forEach(pit => {
                ctx.beginPath();
                ctx.arc(pit.x, pit.y, pit.r, 0, Math.PI * 2);

                // Warna dasar
                let color = pit.big ? "#78350f" : "#92400e";
                if (pit.highlight) color = "#f59e0b"; // warna highlight

                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = "#451a03";
                ctx.stroke();

                // Jumlah biji
                ctx.fillStyle = "white";
                ctx.font = "bold 16px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(pit.biji, pit.x, pit.y);
            });
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
        }



        function drawBoard() {
            ctx.fillStyle = boardPattern || "#b45309";
            roundRect(ctx, 0, 50, 700, 200, 90);
            drawlubang();
            // console.log(lubang);
        }


        let currentPlayer = 1; // 1 atau 2
        let selectedPit = null;
        let isAnimating = false;

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBoard();
            // Tampilkan giliran di atas
            ctx.fillStyle = currentPlayer === 1 ? "#1e3a8a" : "#7c2d12";
            ctx.font = "bold 20px sans-serif";
            ctx.textAlign = "center";
            if (currentPlayer === 1) {
                ctx.fillText(`Giliran: Player ${currentPlayer}`, canvas.width / 2, 30);
            } else {
                ctx.fillText(`Giliran: Player ${currentPlayer}`, canvas.width / 2, canvas.height - 30);
            }

        }

        render();
        if (currentPlayer === 1 && smallPitsEmpty(1)) {
            currentPlayer = 2;
            render();
        } else if (currentPlayer === 2 && smallPitsEmpty(2)) {
            currentPlayer = 1;
            render();
        }
        checkAndShowWinner();

        function houseIndex(p) { return p === 1 ? 15 : 14; }
        function isOwnSmallPit(i, p) { return p === 1 ? (i >= 0 && i <= 6) : (i >= 7 && i <= 13); }
        function isHouse(i) { return i === 14 || i === 15; }
        function oppositeIndex(i) { return i >= 0 && i <= 13 ? 13 - i : -1; }

        function nextIndex(i) {
            if (i === 6) return 15;
            if (i === 15) return 7;
            if (i === 13) return 14;
            if (i === 14) return 0;
            return (i + 1) % lubang.length;
        }

        function smallPitsEmpty(player) {
            const start = player === 1 ? 0 : 7;
            const end = player === 1 ? 6 : 13;
            for (let i = start; i <= end; i++) {
                if (lubang[i].biji > 0) return false;
            }
            return true;
        }

        function allSmallPitsEmpty() {
            return smallPitsEmpty(1) && smallPitsEmpty(2);
        }

        function openWinnerModal(winner, p1Score, p2Score) {
            winnerText.textContent = winner ? (`Pemenang: ${winner}`) : 'Seri!';
            scoreText.textContent = `Player 1: ${p1Score} • Player 2: ${p2Score}`;
            winnerModal.classList.remove('hidden');
            winnerModal.classList.add('flex');
        }

        function closeWinnerModal() {
            winnerModal.classList.add('hidden');
            winnerModal.classList.remove('flex');
        }

        playAgainBtn.addEventListener('click', () => {
            location.reload();
        });

        winnerModal.addEventListener('click', (e) => {
            if (e.target === winnerModal) closeWinnerModal();
        });

        function checkAndShowWinner() {
            if (!allSmallPitsEmpty()) return;
            const p1Score = lubang[15].biji;
            const p2Score = lubang[14].biji;
            let winner = null;
            if (p1Score > p2Score) winner = 'Player 1';
            else if (p2Score > p1Score) winner = 'Player 2';
            openWinnerModal(winner, p1Score, p2Score);
        }

        // Fungsi cek apakah klik di dalam lubang
        function getClickedPit(x, y) {
            return lubang.findIndex(p => {
                const dx = x - p.x;
                const dy = y - p.y;
                return Math.sqrt(dx * dx + dy * dy) < p.r;
            });
        }

        // Tambah event klik pada canvas
        canvas.addEventListener("click", async (e) => {
            if (currentPlayer === 1 && smallPitsEmpty(1)) {
                currentPlayer = 2;
                render();
                return;
            }
            if (currentPlayer === 2 && smallPitsEmpty(2)) {
                currentPlayer = 1;
                render();
                return;
            }
            // console.log("Canvas di klik");

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            // console.log(`x = ${x}, y = ${y}`);


            const idx = getClickedPit(x, y);
            const idxnow = idx + 1;
            if (currentPlayer == 1) {
                console.log("PLayer 1 klik lubang = " + idxnow + `, indek = ${idx}`);
            } else {
                console.log("PLayer 2 klik lubang = " + idxnow + `, indek = ${idx}`);
            }

            if (idx === -1) return;

            const pit = lubang[idx];

            if (currentPlayer == 1) {
                // console.log("PLayer 1 pit biji  = " + pit.biji + `, pit big(rumah) = ${pit.big}`);
            } else {
                // console.log("PLayer 2 pit biji = " + pit.biji + `, pit big(rumah) = ${pit.big}`);
            }

            if (pit.big || pit.biji === 0) return;

            const isPlayer1Pit = idx < 7;
            // console.log(`Apakah lubang player 1 = ${isPlayer1Pit}`);

            const isPlayer2Pit = idx >= 7 && idx < 14;
            // console.log(`Apakah lubang player 2 = ${isPlayer2Pit}`);

            if ((currentPlayer === 1 && !isPlayer1Pit) ||
                (currentPlayer === 2 && !isPlayer2Pit)) return;
            if (isAnimating) return;

            // Ambil biji
            let biji = pit.biji;
            pit.biji = 0;
            render();

            isAnimating = true;
            let i = idx;

            let getPosisiLubangTerakhir;
            let ambilBijiLubangTerakhir;
            let count = 0;
            while (true) {
                while (biji > 0) {

                    i = nextIndex(i);
                    console.log("Hasil dari nextIndex = " + i);
                    if (currentPlayer === 1 && i === 14) { i = nextIndex(i); }
                    if (currentPlayer === 2 && i === 15) { i = nextIndex(i); }
                    lubang[i].biji++;
                    // console.log(`lubang[i].biji++ = ${lubang[i].biji++}`);

                    lubang[i].highlight = true;
                    render();
                    await new Promise(r => setTimeout(r, 500));
                    lubang[i].highlight = false;
                    render();
                    biji--;
                    console.log("biji saat ini " + biji);

                    getPosisiLubangTerakhir = i
                    ambilBijiLubangTerakhir = lubang[getPosisiLubangTerakhir].biji;
                    // console.log(`Posisi lubang terakhir = ${getPosisiLubangTerakhir} berisi ${ambilBijiLubangTerakhir} biji`);


                    if (biji == 0) {
                        biji = getLubangTerakhir()

                    } else {
                        continue
                    }


                }

                function getLubangTerakhir() {
                    // cek posisi lubang terakhir
                    if (getPosisiLubangTerakhir && biji == 0) {
                        // console.log(`getPosisiLubangTerakhir = ${getPosisiLubangTerakhir}`);
                    }

                    // lanjut jalan untuk player 1
                    // kosong kan posisi lubang akhir
                    // lanjut ketika posisi lubang akhir !== 15 dan jumlah biji dilubang akhir > 0
                    if (currentPlayer == 1 && getPosisiLubangTerakhir !== 15) {
                        biji = ambilBijiLubangTerakhir;
                        // cek biji terakhir
                        if (ambilBijiLubangTerakhir > 0) {
                            console.log("biji saat ini " + biji);
                            lubang[getPosisiLubangTerakhir].biji = 0;
                        }
                    }

                    // lanjut jalan untuk player 2
                    // kosong kan posisi lubang akhir
                    // lanjut ketika posisi lubang akhir !== 6 dan jumlah biji dilubang akhir > 0
                    if (currentPlayer == 2 && getPosisiLubangTerakhir !== 14) {
                        biji = ambilBijiLubangTerakhir;
                        // cek biji terakhir
                        if (ambilBijiLubangTerakhir > 0) {
                            console.log("biji saat ini " + biji);
                            lubang[getPosisiLubangTerakhir].biji = 0;
                        }
                    }

                    return biji;
                }

                if ((currentPlayer === 1 && i === 15) || (currentPlayer === 2 && i === 14)) {
                    break;
                }


                currentPlayer = currentPlayer === 1 ? 2 : 1;
                if (currentPlayer === 1 && smallPitsEmpty(1)) {
                    currentPlayer = 2;
                } else if (currentPlayer === 2 && smallPitsEmpty(2)) {
                    currentPlayer = 1;
                }
                break;
            }

            isAnimating = false;
            render();
            checkAndShowWinner();
        });



    </script>
</body>

</html>