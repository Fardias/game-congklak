<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Congklak Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type=range].range-yellow {
            accent-color: #a16207;
        }

        input[type=range].range-yellow::-webkit-slider-runnable-track {
            background: #fde68a;
            height: 6px;
            border-radius: 9999px;
        }

        input[type=range].range-yellow::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            background: #a16207;
            border-radius: 9999px;
            margin-top: -5px;
        }

        input[type=range].range-yellow::-moz-range-track {
            background: #fde68a;
            height: 6px;
            border-radius: 9999px;
        }

        input[type=range].range-yellow::-moz-range-thumb {
            background: #a16207;
            height: 16px;
            width: 16px;
            border: none;
            border-radius: 9999px;
        }
    </style>
</head>

<body class="bg-[url('img/bg-nusantara.jpg')] bg-cover bg-center flex flex-col items-center justify-center min-h-screen">

    <div class="absolute top-4 right-4" id="settingsBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-gear-fill"
            viewBox="0 0 16 16">
            <path
                d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" />
        </svg>
    </div>
    <div id="settingsPanel" class="absolute top-16 right-4 hidden w-64 bg-white rounded-lg shadow-lg p-4 z-40">
        <div class="space-y-3">
            <label class="block">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-700">Volume</span>
                    <span id="volumeValue" class="text-sm text-gray-700">70%</span>
                </div>
                <input type="range" id="volumeSlider" min="0" max="100" step="1" class="mt-2 w-full range-yellow">
            </label>
            <a href="index.html"
                class="block text-center px-3 py-2 rounded-md bg-yellow-700 text-white hover:opacity-80">Kembali ke
                Home</a>
        </div>
    </div>
    <div id="winnerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md p-6 text-center">
            <h2 class="text-xl font-bold text-yellow-700 mb-2">Hasil Permainan</h2>
            <p id="winnerText" class="text-gray-800 mb-2">Pemenang: -</p>
            <div id="scoreText" class="text-sm text-gray-600 mb-6">Player 1: 0 • Player 2: 0</div>
            <div class="flex justify-center space-x-3">
                <button id="playAgainBtn" class="px-4 py-2 rounded-md bg-yellow-700 text-white hover:opacity-80">Main
                    Lagi</button>
                <a href="index.html" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">Kembali ke
                    Home</a>
            </div>
        </div>
    </div>


    <canvas id="congklakCanvas" width="700" height="300" class=""></canvas>
    <audio id="bgAudio" src="song.mp3" preload="auto" loop></audio>

    <script>
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const audio = document.getElementById('bgAudio');
        const winnerModal = document.getElementById('winnerModal');
        const winnerText = document.getElementById('winnerText');
        const scoreText = document.getElementById('scoreText');
        const playAgainBtn = document.getElementById('playAgainBtn');
        let audioPlayed = false;

        function initAudioFromStorage() {
            const saved = parseFloat(localStorage.getItem('volume') || '0.7');
            const vol = isNaN(saved) ? 0.7 : Math.max(0, Math.min(1, saved));
            audio.volume = vol;
            audio.loop = true;
            if (volumeSlider) volumeSlider.value = String(Math.round(vol * 100));
            if (volumeValue) volumeValue.textContent = volumeSlider.value + '%';
        }

        function tryPlayAudio() {
            // console.log("mencoba memainkan audio");

            audio.play().then(() => { audioPlayed = true; }).catch(() => { });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initAudioFromStorage();
            tryPlayAudio();
        });

        function ensureAudioOnFirstInteraction() {
            if (audioPlayed) return;
            const handler = () => {
                initAudioFromStorage();
                tryPlayAudio();
                document.removeEventListener('click', handler);
                document.removeEventListener('keydown', handler);
            };
            document.addEventListener('click', handler, { once: true });
            document.addEventListener('keydown', handler, { once: true });
        }
        ensureAudioOnFirstInteraction();

        settingsBtn.addEventListener('click', () => {
            const isHidden = settingsPanel.classList.contains('hidden');
            if (isHidden) settingsPanel.classList.remove('hidden'); else settingsPanel.classList.add('hidden');
        });

        volumeSlider.addEventListener('input', function () {
            const vol = parseInt(volumeSlider.value, 10);
            const norm = Math.max(0, Math.min(100, isNaN(vol) ? 70 : vol)) / 100;
            audio.volume = norm;
            if (volumeValue) volumeValue.textContent = String(Math.round(norm * 100)) + '%';
        });

        volumeSlider.addEventListener('change', function () {
            const vol = parseInt(volumeSlider.value, 10);
            const norm = Math.max(0, Math.min(100, isNaN(vol) ? 70 : vol)) / 100;
            localStorage.setItem('volume', String(norm));
        });

        const canvas = document.getElementById("congklakCanvas");
        const ctx = canvas.getContext("2d");
        const woodImg = new Image();
        woodImg.src = 'img/tekstur-kayu.png';
        let boardPattern = null;
        woodImg.onload = () => {
            boardPattern = ctx.createPattern(woodImg, 'repeat');
            render();
        };

        const lubang = [];

        // 7 lubang Player 1 (atas)
        for (let i = 0; i < 7; i++) {
            lubang.push({ x: 125 + i * 75, y: 100, r: 25, biji: 1 });
        }

        // 7 lubang Player 2 (bawah)
        for (let i = 0; i < 7; i++) {
            lubang.push({ x: 125 + (6 - i) * 75, y: 200, r: 25, biji: 1 });
        }

        // lubah besar kiri (Player 2)
        lubang.push({ x: 50, y: 150, r: 35, biji: 0, big: true });

        // lubah besar kanan (Player 1)
        lubang.push({ x: 650, y: 150, r: 35, biji: 0, big: true });

        function drawSeed(x, y, size = 4) {
            // Gambar biji dengan gradient coklat
            const gradient = ctx.createRadialGradient(x - 1, y - 1, 0, x, y, size);
            gradient.addColorStop(0, "#ffffff");
            gradient.addColorStop(0.7, "#ffffff");
            gradient.addColorStop(1, "#ffffff");
            
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Highlight kecil untuk efek 3D
            ctx.beginPath();
            ctx.arc(x - 1, y - 1, size * 0.3, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(139, 69, 19, 0.8)";
            ctx.fill();
        }

        function drawSeedsInPit(pit) {
            const count = pit.biji;
            if (count === 0) return;
            
            const maxRadius = pit.r - 6;
            const seedSize = pit.big ? 3 : 2.5;
            
            if (count === 1) {
                drawSeed(pit.x, pit.y, seedSize);
                return;
            }
            
            // Untuk biji lebih dari 1, susun dalam pola melingkar
            const positions = [];
            
            if (count <= 8) {
                // Pola melingkar sederhana
                const angleStep = (2 * Math.PI) / count;
                const radius = Math.min(maxRadius * 0.6, count * 2);
                
                for (let i = 0; i < count; i++) {
                    const angle = i * angleStep;
                    const x = pit.x + Math.cos(angle) * radius;
                    const y = pit.y + Math.sin(angle) * radius;
                    positions.push({ x, y });
                }
            } else {
                // Untuk biji banyak, susun dalam beberapa lingkaran
                const innerCount = Math.min(6, count);
                const outerCount = count - innerCount;
                
                // Lingkaran dalam
                const innerAngleStep = (2 * Math.PI) / innerCount;
                const innerRadius = maxRadius * 0.3;
                
                for (let i = 0; i < innerCount; i++) {
                    const angle = i * innerAngleStep;
                    const x = pit.x + Math.cos(angle) * innerRadius;
                    const y = pit.y + Math.sin(angle) * innerRadius;
                    positions.push({ x, y });
                }
                
                // Lingkaran luar
                if (outerCount > 0) {
                    const outerAngleStep = (2 * Math.PI) / outerCount;
                    const outerRadius = maxRadius * 0.7;
                    
                    for (let i = 0; i < outerCount; i++) {
                        const angle = i * outerAngleStep;
                        const x = pit.x + Math.cos(angle) * outerRadius;
                        const y = pit.y + Math.sin(angle) * outerRadius;
                        positions.push({ x, y });
                    }
                }
            }
            
            // Gambar semua biji
            positions.forEach(pos => {
                drawSeed(pos.x, pos.y, seedSize);
            });
            
            // Tampilkan angka jika biji terlalu banyak (lebih dari 15)
            if (count > 15) {
                ctx.fillStyle = "white";
                ctx.font = "bold 12px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.strokeStyle = "#451a03";
                ctx.lineWidth = 2;
                ctx.strokeText(count, pit.x, pit.y + pit.r + 15);
                ctx.fillText(count, pit.x, pit.y + pit.r + 15);
            }
        }

        function drawlubang() {
            lubang.forEach((pit, index) => {
                ctx.beginPath();
                ctx.arc(pit.x, pit.y, pit.r, 0, Math.PI * 2);

                // Warna dasar
                let color = pit.big ? "#78350f" : "#92400e";
                if (pit.highlight) color = "#f59e0b"; // warna highlight

                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = "#451a03";
                ctx.stroke();

                // Gambar biji-biji
                drawSeedsInPit(pit);
                
                // Tampilkan angka di bawah setiap lubang
                ctx.fillStyle = "white";
                ctx.strokeStyle = "#451a03";
                ctx.lineWidth = 3;
                ctx.font = "bold 14px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                
                const textY = pit.y + pit.r + (pit.big ? 20 : 18);
                
                // Stroke untuk outline
                ctx.strokeText(pit.biji, pit.x, textY);
                // Fill untuk teks utama
                ctx.fillText(pit.biji, pit.x, textY);
            });
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
        }



        function drawBoard() {
            ctx.fillStyle = boardPattern || "#b45309";
            roundRect(ctx, 0, 50, 700, 200, 90);
            drawlubang();
            // console.log(lubang);
        }


        let currentPlayer = 1; // 1 atau 2
        let selectedPit = null;
        let isAnimating = false;

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBoard();
            // Tampilkan giliran di atas
            ctx.fillStyle = currentPlayer === 1 ? "#1e3a8a" : "#7c2d12";
            ctx.font = "bold 20px sans-serif";
            ctx.textAlign = "center";
            if (currentPlayer === 1) {
                ctx.fillText(`Giliran: Player ${currentPlayer}`, canvas.width / 2, 30);
            } else {
                ctx.fillText(`Giliran: Player ${currentPlayer}`, canvas.width / 2, canvas.height - 30);
            }

        }

        render();
        if (currentPlayer === 1 && smallPitsEmpty(1)) {
            currentPlayer = 2;
            render();
        } else if (currentPlayer === 2 && smallPitsEmpty(2)) {
            currentPlayer = 1;
            render();
        }
        checkAndShowWinner();

        function houseIndex(p) { return p === 1 ? 15 : 14; }
        function isOwnSmallPit(i, p) { return p === 1 ? (i >= 0 && i <= 6) : (i >= 7 && i <= 13); }
        function isHouse(i) { return i === 14 || i === 15; }
        function oppositeIndex(i) { return i >= 0 && i <= 13 ? 13 - i : -1; }

        function nextIndex(i) {
            if (i === 6) return 15;
            if (i === 15) return 7;
            if (i === 13) return 14;
            if (i === 14) return 0;
            return (i + 1) % lubang.length;
        }

        function smallPitsEmpty(player) {
            const start = player === 1 ? 0 : 7;
            const end = player === 1 ? 6 : 13;
            for (let i = start; i <= end; i++) {
                if (lubang[i].biji > 0) return false;
            }
            return true;
        }

        function allSmallPitsEmpty() {
            return smallPitsEmpty(1) && smallPitsEmpty(2);
        }

        function openWinnerModal(winner, p1Score, p2Score) {
            winnerText.textContent = winner ? (`Pemenang: ${winner}`) : 'Seri!';
            scoreText.textContent = `Player 1: ${p1Score} • Player 2: ${p2Score}`;
            winnerModal.classList.remove('hidden');
            winnerModal.classList.add('flex');
        }

        function closeWinnerModal() {
            winnerModal.classList.add('hidden');
            winnerModal.classList.remove('flex');
        }

        playAgainBtn.addEventListener('click', () => {
            location.reload();
        });

        winnerModal.addEventListener('click', (e) => {
            if (e.target === winnerModal) closeWinnerModal();
        });

        function checkAndShowWinner() {
            if (!allSmallPitsEmpty()) return;
            const p1Score = lubang[15].biji;
            const p2Score = lubang[14].biji;
            let winner = null;
            if (p1Score > p2Score) winner = 'Player 1';
            else if (p2Score > p1Score) winner = 'Player 2';
            openWinnerModal(winner, p1Score, p2Score);
        }

        // Fungsi cek apakah klik di dalam lubang
        function getClickedPit(x, y) {
            return lubang.findIndex(p => {
                const dx = x - p.x;
                const dy = y - p.y;
                return Math.sqrt(dx * dx + dy * dy) < p.r;
            });
        }

        // Tambah event klik pada canvas
        canvas.addEventListener("click", async (e) => {
            if (currentPlayer === 1 && smallPitsEmpty(1)) {
                currentPlayer = 2;
                render();
                return;
            }
            if (currentPlayer === 2 && smallPitsEmpty(2)) {
                currentPlayer = 1;
                render();
                return;
            }
            // console.log("Canvas di klik");

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            // console.log(`x = ${x}, y = ${y}`);


            const idx = getClickedPit(x, y);
            const idxnow = idx + 1;
            if (currentPlayer == 1) {
                console.log("PLayer 1 klik lubang = " + idxnow + `, indek = ${idx}`);
            } else {
                console.log("PLayer 2 klik lubang = " + idxnow + `, indek = ${idx}`);
            }

            if (idx === -1) return;

            const pit = lubang[idx];

            if (currentPlayer == 1) {
                // console.log("PLayer 1 pit biji  = " + pit.biji + `, pit big(rumah) = ${pit.big}`);
            } else {
                // console.log("PLayer 2 pit biji = " + pit.biji + `, pit big(rumah) = ${pit.big}`);
            }

            if (pit.big || pit.biji === 0) return;

            const isPlayer1Pit = idx < 7;
            // console.log(`Apakah lubang player 1 = ${isPlayer1Pit}`);

            const isPlayer2Pit = idx >= 7 && idx < 14;
            // console.log(`Apakah lubang player 2 = ${isPlayer2Pit}`);

            if ((currentPlayer === 1 && !isPlayer1Pit) ||
                (currentPlayer === 2 && !isPlayer2Pit)) return;
            if (isAnimating) return;

            // Ambil biji
            let biji = pit.biji;
            pit.biji = 0;
            render();

            isAnimating = true;
            let i = idx;

            let getPosisiLubangTerakhir;
            let ambilBijiLubangTerakhir;
            let count = 0;
            while (true) {
                while (biji > 0) {

                    i = nextIndex(i);
                    console.log("Hasil dari nextIndex = " + i);
                    if (currentPlayer === 1 && i === 14) { i = nextIndex(i); }
                    if (currentPlayer === 2 && i === 15) { i = nextIndex(i); }
                    lubang[i].biji++;
                    // console.log(`lubang[i].biji++ = ${lubang[i].biji++}`);

                    lubang[i].highlight = true;
                    render();
                    await new Promise(r => setTimeout(r, 500));
                    lubang[i].highlight = false;
                    render();
                    biji--;
                    console.log("biji saat ini " + biji);

                    getPosisiLubangTerakhir = i
                    ambilBijiLubangTerakhir = lubang[getPosisiLubangTerakhir].biji;
                    // console.log(`Posisi lubang terakhir = ${getPosisiLubangTerakhir} berisi ${ambilBijiLubangTerakhir} biji`);


                    if (biji == 0) {
                        biji = getLubangTerakhir()

                    } else {
                        continue
                    }


                }

                function getLubangTerakhir() {
                    // Aturan Congklak: Jika biji terakhir jatuh di lubang kosong (yang sekarang berisi 1), 
                    // maka giliran berakhir dan ganti pemain
                    
                    // Cek apakah lubang terakhir adalah rumah sendiri
                    const isOwnHouse = (currentPlayer === 1 && getPosisiLubangTerakhir === 15) || 
                                      (currentPlayer === 2 && getPosisiLubangTerakhir === 14);
                    
                    // Jika biji terakhir jatuh di rumah sendiri, pemain dapat giliran lagi
                    if (isOwnHouse) {
                        console.log("Biji terakhir di rumah sendiri, dapat giliran lagi!");
                        return 0; // Tidak lanjut, tapi tidak ganti pemain
                    }
                    
                    // Cek apakah lubang terakhir adalah lubang kecil dan sebelumnya kosong
                    const isSmallPit = getPosisiLubangTerakhir < 14;
                    const wasEmpty = ambilBijiLubangTerakhir === 1; // Sekarang berisi 1, berarti sebelumnya kosong
                    const isOwnPit = isOwnSmallPit(getPosisiLubangTerakhir, currentPlayer);
                    
                    if (isSmallPit && wasEmpty && isOwnPit) {
                        // ATURAN MENEMBAK: Biji terakhir jatuh di lubang kosong milik sendiri
                        const oppositeIdx = oppositeIndex(getPosisiLubangTerakhir);
                        
                        if (oppositeIdx !== -1 && lubang[oppositeIdx].biji > 0) {
                            console.log(`MENEMBAK! Lubang ${getPosisiLubangTerakhir} menembak lubang ${oppositeIdx}`);
                            console.log(`Mengambil ${lubang[oppositeIdx].biji} biji dari lawan`);
                            
                            // Ambil semua biji dari lubang lawan yang berseberangan
                            const capturedSeeds = lubang[oppositeIdx].biji;
                            lubang[oppositeIdx].biji = 0;
                            
                            // Ambil juga biji dari lubang sendiri (yang baru ditaruh)
                            const ownSeed = lubang[getPosisiLubangTerakhir].biji;
                            lubang[getPosisiLubangTerakhir].biji = 0;
                            
                            // Masukkan semua biji yang ditembak ke rumah sendiri
                            const totalCaptured = capturedSeeds + ownSeed;
                            const ownHouseIdx = currentPlayer === 1 ? 15 : 14;
                            lubang[ownHouseIdx].biji += totalCaptured;
                            
                            console.log(`Total biji yang masuk ke rumah: ${totalCaptured}`);
                            render(); // Update tampilan setelah menembak
                        } else {
                            console.log("Biji terakhir jatuh di lubang kosong, tapi tidak bisa menembak (lubang lawan kosong)");
                        }
                        
                        return 0; // Berhenti, ganti pemain
                    } else if (isSmallPit && wasEmpty) {
                        console.log("Biji terakhir jatuh di lubang kosong lawan, giliran berakhir!");
                        return 0; // Berhenti, ganti pemain
                    }
                    
                    // Jika lubang terakhir berisi lebih dari 1 biji, lanjutkan permainan
                    if (ambilBijiLubangTerakhir > 1) {
                        console.log(`Lubang terakhir berisi ${ambilBijiLubangTerakhir} biji, ambil semua dan lanjut jalan!`);
                        const newBiji = ambilBijiLubangTerakhir; // Ambil SEMUA biji dari lubang tersebut
                        lubang[getPosisiLubangTerakhir].biji = 0; // Kosongkan lubang tersebut
                        return newBiji;
                    }
                    
                    return 0; // Default: berhenti
                }

                // Cek apakah biji terakhir jatuh di rumah sendiri
                const lastInOwnHouse = (currentPlayer === 1 && i === 15) || (currentPlayer === 2 && i === 14);
                
                if (lastInOwnHouse) {
                    console.log("Biji terakhir di rumah sendiri, pemain dapat giliran lagi!");
                    break; // Pemain tetap sama, tidak ganti
                }

                // Jika tidak di rumah sendiri, ganti pemain
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                console.log(`Ganti ke Player ${currentPlayer}`);
                
                // Cek apakah pemain baru masih punya biji untuk dimainkan
                if (currentPlayer === 1 && smallPitsEmpty(1)) {
                    currentPlayer = 2;
                } else if (currentPlayer === 2 && smallPitsEmpty(2)) {
                    currentPlayer = 1;
                }
                break;
            }

            isAnimating = false;
            render();
            checkAndShowWinner();
        });



    </script>
</body>

</html>